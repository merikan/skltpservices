title Engagemangsindex - Pullfunktion NTjP utan RTP

EI_Pull->PropertyResolver: get("ei.pull.belongsto.hsaid")
PropertyResolver->EI_Pull: Address till tjänstekatalogen

EI_Pull->PropertyResolver: get("ei.push.address.servicedomain")
PropertyResolver->EI_Pull: URI till Tjänstekatalogen

EI_Pull->PropertyResolver: get("ei.address.service.address.logical")
PropertyResolver->EI_Pull: HSA-ID som tjänsten tillhör

EI_Pull->PropertyResolver: get("ei.pull.time.offset")
PropertyResolver->EI_Pull: Tidsoffset i sekunder

EI_Pull->PropertyResolver: get("ei.pull.time.format")
PropertyResolver->EI_Pull: Format för tidsstämpel

EI_Pull->PropertyResolver: get("ei.push.address.logical")
PropertyResolver->EI_Pull: Address till Engagemangsindex

note over EI_Pull, PropertyResolver
Kommaseparerade service domäner läses in från propertyfil
riv:crm:scheduling, riv:itintegration:engagementindex, riv:careprocess:request
end note

EI_Pull->PropertyResolver: get("ei.pull.address.servicedomains")
PropertyResolver->EI_Pull: commaSeparatedStringList

note over EI_Pull,EngagementIndexHelper:
Kommaseparerad sträng görs om till lista
end note

EI_Pull->EngagementIndexHelper: stringToList(commaSeparatedStringList)
EngagementIndexHelper->EI_Pull: Lista av service domäner

EI_Pull->EngagementIndexHelper: getFormattedOffsetTime(dateNow, timeOffset, "yyyyMMddHHmmss")
PropertyResolver->EI_Pull: Omräknad, formaterad tidsstämpel

note over EI_Pull, NTjP
Hämta logiska adresser som konsument får göra getUpdates på:
Konsument HSA ID: HSASERVICES-100M
Tjänstekontrakt: urn:riv:itintegration:engagementindex:GetUpdates:1:rivtabp21
end note

EI_Pull->NTjP: GetLogicalAddressesByServiceContract
NTjP->Tjänsteadresseringskatalog: GetLogicalAddressesByServiceContract
Tjänsteadresseringskatalog->NTjP: Lista av logiska adresser
NTjP->EI_Pull: Lista av logiska adresser

note over EI_Pull, NTjP
Lista med logiska adresser som konsumenten får göra getUpdates på:
SE2321000016-1K2W
HSA-456
HSA-789
end note

note over EI_Pull, EngagementIndexHelper
Den kommaseparerade strängen görs om till en lista.
{ (riv:crm:scheduling), (riv:itintegration:engagementindex), (riv:careprocess:request) }
end note

loop för varje logisk adress
loop för varje service domäns
loop för varje deluppdatering (optionellt)

EI_Pull->NTjP: GetUpdates
NTjP->Producent: GetUpdates

note over EI_Pull, Tjänsteadresseringskatalog
Hämta för:
logicalAddress: SE2321000016-1K2W
tjänstedomän: urn:riv:crm:scheduling
vid eller efter tid: 20111010T100000
end note

Producent->NTjP: Lista med uppdateringar
NTjP->EI_Pull: Lista med uppdateringar

EI_Pull->NTjP: Update
NTjP->N EI: Update
N EI->NTjP: Resultat (status + text)
NTjP->EI_Pull:  Resultat (status + text)

note right of EI_Pull
Vid fel, logga felet och gå vidare
med nästa logiska adress
end note

end
end
end
